!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define("colyseus.js",["exports"],e):(t="undefined"!=typeof globalThis?globalThis:t||self,e(t.Colyseus={}))}(this,function(t){"use strict";ArrayBuffer.isView||(ArrayBuffer.isView=function(t){return null!==t&&"object"==typeof t&&t.buffer instanceof ArrayBuffer}),"undefined"==typeof globalThis&&"undefined"!=typeof window&&(window.globalThis=window);var e,n,i,o=function(t,e){return(o=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};function r(t,e){if("function"!=typeof e&&null!==e)throw TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function s(t,e,n,i){return new(n||(n=Promise))(function(o,r){function s(t){try{a(i.next(t))}catch(e){r(e)}}function c(t){try{a(i.throw(t))}catch(e){r(e)}}function a(t){var e;t.done?o(t.value):((e=t.value)instanceof n?e:new n(function(t){t(e)})).then(s,c)}a((i=i.apply(t,e||[])).next())})}function c(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function c(c){return function(a){return function c(a){if(n)throw TypeError("Generator is already executing.");for(;r&&(r=0,a[0]&&(s=0)),s;)try{if(n=1,i&&(o=2&a[0]?i.return:a[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,a[1])).done)return o;switch(i=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,i=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===a[0]||2===a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(f){a=[6,f],i=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([c,a])}}}function a(t,e){e.statusMessage=t.statusText,e.statusCode=t.status,e.data=t.body}function f(t,e,n){var i,o,r=(n=n||{}).body;return n.method=t,n.headers=n.headers||{},r instanceof FormData||r&&"object"==typeof r&&(n.headers["content-type"]="application/json",n.body=JSON.stringify(r)),n.withCredentials&&(n.credentials="include"),n.timeout&&(o=new AbortController,n.signal=o.signal,i=setTimeout(o.abort,n.timeout)),new Promise((t,s)=>{fetch(e,n).then((e,o)=>{clearTimeout(i),a(e,e),o=e.status>=400?s:t,(r=e.headers.get("content-type"))&&~r.indexOf("application/json")?e.text().then(t=>{try{e.data=JSON.parse(t,n.reviver),o(e)}catch(i){i.headers=e.headers,a(e,i),s(i)}}):o(e)}).catch(t=>{t.timeout=o&&o.signal.aborted,s(t)})})}var u,h,d,l=f.bind(f,"GET"),$=f.bind(f,"POST"),p=f.bind(f,"PATCH"),v=f.bind(f,"DELETE"),y=f.bind(f,"PUT"),g=v,x=l,m=p,E=$,_=y,A=f,O={del:g,get:x,patch:m,post:E,put:_,send:A},I=(u={__proto__:null,default:O,del:g,get:x,patch:m,post:E,put:_,send:A},(h=[O]).forEach(function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach(function(e){if("default"!==e&&!(e in u)){var n=Object.getOwnPropertyDescriptor(t,e);Object.defineProperty(u,e,n.get?n:{enumerable:!0,get:function(){return t[e]}})}})}),Object.freeze(u));(d=e||(e={}))[d.CONSENTED=4e3]="CONSENTED",d[d.DEVMODE_RESTART=4010]="DEVMODE_RESTART";var w=function(t){function e(e,n){var i=t.call(this,n)||this;return i.name="ServerError",i.code=e,i}return r(e,t),e}(Error);function b(t,e){if(this._offset=e,t instanceof ArrayBuffer)this._buffer=t,this._view=new DataView(this._buffer);else if(ArrayBuffer.isView(t))this._buffer=t.buffer,this._view=new DataView(this._buffer,t.byteOffset,t.byteLength);else throw Error("Invalid argument")}function T(t,e,n){for(var i=0,o=0,r=n.length;o<r;o++)(i=n.charCodeAt(o))<128?t.setUint8(e++,i):i<2048?(t.setUint8(e++,192|i>>6),t.setUint8(e++,128|63&i)):i<55296||i>=57344?(t.setUint8(e++,224|i>>12),t.setUint8(e++,128|i>>6&63),t.setUint8(e++,128|63&i)):(o++,i=65536+((1023&i)<<10|1023&n.charCodeAt(o)),t.setUint8(e++,240|i>>18),t.setUint8(e++,128|i>>12&63),t.setUint8(e++,128|i>>6&63),t.setUint8(e++,128|63&i))}b.prototype._array=function(t){for(var e=Array(t),n=0;n<t;n++)e[n]=this._parse();return e},b.prototype._map=function(t){for(var e="",n={},i=0;i<t;i++)n[e=this._parse()]=this._parse();return n},b.prototype._str=function(t){var e=function t(e,n,i){for(var o="",r=0,s=n,c=n+i;s<c;s++){var a=e.getUint8(s);if((128&a)==0){o+=String.fromCharCode(a);continue}if((224&a)==192){o+=String.fromCharCode((31&a)<<6|63&e.getUint8(++s));continue}if((240&a)==224){o+=String.fromCharCode((15&a)<<12|(63&e.getUint8(++s))<<6|(63&e.getUint8(++s))<<0);continue}if((248&a)==240){(r=(7&a)<<18|(63&e.getUint8(++s))<<12|(63&e.getUint8(++s))<<6|(63&e.getUint8(++s))<<0)>=65536?(r-=65536,o+=String.fromCharCode((r>>>10)+55296,(1023&r)+56320)):o+=String.fromCharCode(r);continue}throw Error("Invalid byte "+a.toString(16))}return o}(this._view,this._offset,t);return this._offset+=t,e},b.prototype._bin=function(t){var e=this._buffer.slice(this._offset,this._offset+t);return this._offset+=t,e},b.prototype._parse=function(){var t,e=this._view.getUint8(this._offset++),n=0,i=0,o=0,r=0;if(e<192)return e<128?e:e<144?this._map(15&e):e<160?this._array(15&e):this._str(31&e);if(e>223)return-((255-e+1)*1);switch(e){case 192:return null;case 194:return!1;case 195:return!0;case 196:return n=this._view.getUint8(this._offset),this._offset+=1,this._bin(n);case 197:return n=this._view.getUint16(this._offset),this._offset+=2,this._bin(n);case 198:return n=this._view.getUint32(this._offset),this._offset+=4,this._bin(n);case 199:if(n=this._view.getUint8(this._offset),i=this._view.getInt8(this._offset+1),this._offset+=2,-1===i){var s=this._view.getUint32(this._offset);return o=this._view.getInt32(this._offset+4),r=this._view.getUint32(this._offset+8),this._offset+=12,new Date((4294967296*o+r)*1e3+s/1e6)}return[i,this._bin(n)];case 200:return n=this._view.getUint16(this._offset),i=this._view.getInt8(this._offset+2),this._offset+=3,[i,this._bin(n)];case 201:return n=this._view.getUint32(this._offset),i=this._view.getInt8(this._offset+4),this._offset+=5,[i,this._bin(n)];case 202:return t=this._view.getFloat32(this._offset),this._offset+=4,t;case 203:return t=this._view.getFloat64(this._offset),this._offset+=8,t;case 204:return t=this._view.getUint8(this._offset),this._offset+=1,t;case 205:return t=this._view.getUint16(this._offset),this._offset+=2,t;case 206:return t=this._view.getUint32(this._offset),this._offset+=4,t;case 207:return o=4294967296*this._view.getUint32(this._offset),r=this._view.getUint32(this._offset+4),this._offset+=8,o+r;case 208:return t=this._view.getInt8(this._offset),this._offset+=1,t;case 209:return t=this._view.getInt16(this._offset),this._offset+=2,t;case 210:return t=this._view.getInt32(this._offset),this._offset+=4,t;case 211:return o=4294967296*this._view.getInt32(this._offset),r=this._view.getUint32(this._offset+4),this._offset+=8,o+r;case 212:if(i=this._view.getInt8(this._offset),this._offset+=1,0===i){this._offset+=1;return}return[i,this._bin(1)];case 213:return i=this._view.getInt8(this._offset),this._offset+=1,[i,this._bin(2)];case 214:if(i=this._view.getInt8(this._offset),this._offset+=1,-1===i)return t=this._view.getUint32(this._offset),this._offset+=4,new Date(1e3*t);return[i,this._bin(4)];case 215:if(i=this._view.getInt8(this._offset),this._offset+=1,0===i)return o=4294967296*this._view.getInt32(this._offset),r=this._view.getUint32(this._offset+4),this._offset+=8,new Date(o+r);if(-1===i){o=this._view.getUint32(this._offset),r=this._view.getUint32(this._offset+4),this._offset+=8;var c=(3&o)*4294967296+r;return new Date(1e3*c+(o>>>2)/1e6)}return[i,this._bin(8)];case 216:return i=this._view.getInt8(this._offset),this._offset+=1,[i,this._bin(16)];case 217:return n=this._view.getUint8(this._offset),this._offset+=1,this._str(n);case 218:return n=this._view.getUint16(this._offset),this._offset+=2,this._str(n);case 219:return n=this._view.getUint32(this._offset),this._offset+=4,this._str(n);case 220:return n=this._view.getUint16(this._offset),this._offset+=2,this._array(n);case 221:return n=this._view.getUint32(this._offset),this._offset+=4,this._array(n);case 222:return n=this._view.getUint16(this._offset),this._offset+=2,this._map(n);case 223:return n=this._view.getUint32(this._offset),this._offset+=4,this._map(n)}throw Error("Could not parse")};var R,P,C=function(){throw Error("ws does not work in the browser. Browser clients must use the native WebSocket object")},D=globalThis.WebSocket||C,k=function(){function t(t){this.events=t}return t.prototype.send=function(t){t instanceof ArrayBuffer?this.ws.send(t):Array.isArray(t)&&this.ws.send(new Uint8Array(t).buffer)},t.prototype.connect=function(t){this.ws=new D(t,this.protocols),this.ws.binaryType="arraybuffer",this.ws.onopen=this.events.onopen,this.ws.onmessage=this.events.onmessage,this.ws.onclose=this.events.onclose,this.ws.onerror=this.events.onerror},t.prototype.close=function(t,e){this.ws.close(t,e)},Object.defineProperty(t.prototype,"isOpen",{get:function(){return this.ws.readyState===D.OPEN},enumerable:!1,configurable:!0}),t}(),N=function(){function t(){this.events={},this.transport=new k(this.events)}return t.prototype.send=function(t){this.transport.send(t)},t.prototype.connect=function(t){this.transport.connect(t)},t.prototype.close=function(t,e){this.transport.close(t,e)},Object.defineProperty(t.prototype,"isOpen",{get:function(){return this.transport.isOpen},enumerable:!1,configurable:!0}),t}();function S(t,e){for(var n=t[e++],i="",o=0,r=e,s=e+n;r<s;r++){var c=t[r];if((128&c)==0){i+=String.fromCharCode(c);continue}if((224&c)==192){i+=String.fromCharCode((31&c)<<6|63&t[++r]);continue}if((240&c)==224){i+=String.fromCharCode((15&c)<<12|(63&t[++r])<<6|(63&t[++r])<<0);continue}if((248&c)==240){(o=(7&c)<<18|(63&t[++r])<<12|(63&t[++r])<<6|(63&t[++r])<<0)>=65536?(o-=65536,i+=String.fromCharCode((o>>>10)+55296,(1023&o)+56320)):i+=String.fromCharCode(o);continue}throw Error("Invalid byte "+c.toString(16))}return i}function M(t){void 0===t&&(t="");for(var e=0,n=0,i=0,o=t.length;i<o;i++)(e=t.charCodeAt(i))<128?n+=1:e<2048?n+=2:e<55296||e>=57344?n+=3:(i++,n+=4);return n+1}t.Protocol=void 0,(R=t.Protocol||(t.Protocol={}))[R.HANDSHAKE=9]="HANDSHAKE",R[R.JOIN_ROOM=10]="JOIN_ROOM",R[R.ERROR=11]="ERROR",R[R.LEAVE_ROOM=12]="LEAVE_ROOM",R[R.ROOM_DATA=13]="ROOM_DATA",R[R.ROOM_STATE=14]="ROOM_STATE",R[R.ROOM_STATE_PATCH=15]="ROOM_STATE_PATCH",R[R.ROOM_DATA_SCHEMA=16]="ROOM_DATA_SCHEMA",R[R.ROOM_DATA_BYTES=17]="ROOM_DATA_BYTES",t.ErrorCode=void 0,(P=t.ErrorCode||(t.ErrorCode={}))[P.MATCHMAKE_NO_HANDLER=4210]="MATCHMAKE_NO_HANDLER",P[P.MATCHMAKE_INVALID_CRITERIA=4211]="MATCHMAKE_INVALID_CRITERIA",P[P.MATCHMAKE_INVALID_ROOM_ID=4212]="MATCHMAKE_INVALID_ROOM_ID",P[P.MATCHMAKE_UNHANDLED=4213]="MATCHMAKE_UNHANDLED",P[P.MATCHMAKE_EXPIRED=4214]="MATCHMAKE_EXPIRED",P[P.AUTH_FAILED=4215]="AUTH_FAILED",P[P.APPLICATION_ERROR=4216]="APPLICATION_ERROR";var L={};function U(t,e){L[t]=e}function F(t){var e=L[t];if(!e)throw Error("missing serializer: "+t);return e}var H=function(){function t(){this.handlers=[]}return t.prototype.register=function(t,e){return this.handlers.push(t),this},t.prototype.invoke=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this.handlers.forEach(function(n){return n.apply(t,e)})},t.prototype.invokeAsync=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return Promise.all(this.handlers.map(function(n){return n.apply(t,e)}))},t.prototype.remove=function(t){var e=this.handlers.indexOf(t);this.handlers[e]=this.handlers[this.handlers.length-1],this.handlers.pop()},t.prototype.clear=function(){this.handlers=[]},t}();function B(){var t=new H;function e(e){return t.register(e,this===null)}return e.once=function(e){var n=function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];e.apply(this,i),t.remove(n)};t.register(n)},e.remove=function(e){return t.remove(e)},e.invoke=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return t.invoke.apply(t,e)},e.invokeAsync=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return t.invokeAsync.apply(t,e)},e.clear=function(){return t.clear()},e}var z,V,q="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},J=(V={exports:{}},(z=function(t,e){var n,i;(i=function(t){var e=function(t,n){return(e=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,n)};function n(t,n){if("function"!=typeof n&&null!==n)throw TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}function i(t,e,n,i){var o,r=arguments.length,s=r<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,i);else for(var c=t.length-1;c>=0;c--)(o=t[c])&&(s=(r<3?o(s):r>3?o(e,n,s):o(e,n))||s);return r>3&&s&&Object.defineProperty(e,n,s),s}function o(t,e,n){if(n||2===arguments.length)for(var i,o=0,r=e.length;o<r;o++)!i&&o in e||(i||(i=Array.prototype.slice.call(e,0,o)),i[o]=e[o]);return t.concat(i||Array.prototype.slice.call(e))}t.OPERATION=void 0,(th=t.OPERATION||(t.OPERATION={}))[th.ADD=128]="ADD",th[th.REPLACE=0]="REPLACE",th[th.DELETE=64]="DELETE",th[th.DELETE_AND_ADD=192]="DELETE_AND_ADD",th[th.TOUCH=1]="TOUCH",th[th.CLEAR=10]="CLEAR";var r=function(){function e(t,e,n){this.changed=!1,this.changes=new Map,this.allChanges=new Set,this.caches={},this.currentCustomOperation=0,this.ref=t,this.setParent(e,n)}return e.prototype.setParent=function(t,e,n){var i=this;if(this.indexes||(this.indexes=this.ref instanceof tv?this.ref._definition.indexes:{}),this.parent=t,this.parentIndex=n,e){if(this.root=e,this.ref instanceof tv){var o=this.ref._definition;for(var r in o.schema){var s=this.ref[r];if(s&&s.$changes){var c=o.indexes[r];s.$changes.setParent(this.ref,e,c)}}}else"object"==typeof this.ref&&this.ref.forEach(function(t,e){if(t instanceof tv){var n=t.$changes,o=i.ref.$changes.indexes[e];n.setParent(i.ref,i.root,o)}})}},e.prototype.operation=function(t){this.changes.set(--this.currentCustomOperation,t)},e.prototype.change=function(e,n){void 0===n&&(n=t.OPERATION.ADD);var i="number"==typeof e?e:this.indexes[e];this.assertValidIndex(i,e);var o=this.changes.get(i);o&&o.op!==t.OPERATION.DELETE&&o.op!==t.OPERATION.TOUCH||this.changes.set(i,{op:o&&o.op===t.OPERATION.DELETE?t.OPERATION.DELETE_AND_ADD:n,index:i}),this.allChanges.add(i),this.changed=!0,this.touchParents()},e.prototype.touch=function(e){var n="number"==typeof e?e:this.indexes[e];this.assertValidIndex(n,e),this.changes.has(n)||this.changes.set(n,{op:t.OPERATION.TOUCH,index:n}),this.allChanges.add(n),this.touchParents()},e.prototype.touchParents=function(){this.parent&&this.parent.$changes.touch(this.parentIndex)},e.prototype.getType=function(t){if(this.ref._definition){var e=this.ref._definition;return e.schema[e.fieldsByIndex[t]]}var e=this.parent._definition;return Object.values(e.schema[e.fieldsByIndex[this.parentIndex]])[0]},e.prototype.getChildrenFilter=function(){var t=this.parent._definition.childFilters;return t&&t[this.parentIndex]},e.prototype.getValue=function(t){return this.ref.getByIndex(t)},e.prototype.delete=function(e){var n="number"==typeof e?e:this.indexes[e];if(void 0===n){console.warn("@colyseus/schema ".concat(this.ref.constructor.name,": trying to delete non-existing index: ").concat(e," (").concat(n,")"));return}var i=this.getValue(n);this.changes.set(n,{op:t.OPERATION.DELETE,index:n}),this.allChanges.delete(n),delete this.caches[n],i&&i.$changes&&(i.$changes.parent=void 0),this.changed=!0,this.touchParents()},e.prototype.discard=function(e,n){var i=this;void 0===e&&(e=!1),void 0===n&&(n=!1),this.ref instanceof tv||this.changes.forEach(function(e){if(e.op===t.OPERATION.DELETE){var n=i.ref.getIndex(e.index);delete i.indexes[n]}}),this.changes.clear(),this.changed=e,n&&this.allChanges.clear(),this.currentCustomOperation=0},e.prototype.discardAll=function(){var t=this;this.changes.forEach(function(e){var n=t.getValue(e.index);n&&n.$changes&&n.$changes.discardAll()}),this.discard()},e.prototype.cache=function(t,e){this.caches[t]=e},e.prototype.clone=function(){return new e(this.ref,this.parent,this.root)},e.prototype.ensureRefId=function(){void 0===this.refId&&(this.refId=this.root.getNextUniqueId())},e.prototype.assertValidIndex=function(t,e){if(void 0===t)throw Error('ChangeTree: missing index for field "'.concat(e,'"'))},e}();function s(t,e,n,i){return t[e]||(t[e]=[]),t[e].push(n),null==i||i.forEach(function(t,e){return n(t,e)}),function(){return a(t[e],t[e].indexOf(n))}}function c(e){var n=this,i="string"!=typeof this.$changes.getType();this.$items.forEach(function(o,r){e.push({refId:n.$changes.refId,op:t.OPERATION.DELETE,field:r,value:void 0,previousValue:o}),i&&n.$changes.root.removeRef(o.$changes.refId)})}function a(t,e){if(-1===e||e>=t.length)return!1;for(var n=t.length-1,i=e;i<n;i++)t[i]=t[i+1];return t.length=n,!0}var f=function(t,e){var n=t.toString(),i=e.toString();return n<i?-1:n>i?1:0},u=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.$changes=new r(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,this.push.apply(this,t)}return e.prototype.onAdd=function(e,n){return void 0===n&&(n=!0),s(this.$callbacks||(this.$callbacks=[]),t.OPERATION.ADD,e,n?this.$items:void 0)},e.prototype.onRemove=function(e){return s(this.$callbacks||(this.$callbacks=[]),t.OPERATION.DELETE,e)},e.prototype.onChange=function(e){return s(this.$callbacks||(this.$callbacks=[]),t.OPERATION.REPLACE,e)},e.is=function(t){return Array.isArray(t)||void 0!==t.array},Object.defineProperty(e.prototype,"length",{get:function(){return this.$items.size},set:function(t){0===t?this.clear():this.splice(t,this.length-t)},enumerable:!1,configurable:!0}),e.prototype.push=function(){for(var t,e=this,n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];return n.forEach(function(n){t=e.$refId++,e.setAt(t,n)}),t},e.prototype.pop=function(){var t=Array.from(this.$indexes.values()).pop();if(void 0!==t){this.$changes.delete(t),this.$indexes.delete(t);var e=this.$items.get(t);return this.$items.delete(t),e}},e.prototype.at=function(t){var e=Array.from(this.$items.keys())[t];return this.$items.get(e)},e.prototype.setAt=function(e,n){void 0!==n.$changes&&n.$changes.setParent(this,this.$changes.root,e);var i,o,r=null!==(o=null===(i=this.$changes.indexes[e])||void 0===i?void 0:i.op)&&void 0!==o?o:t.OPERATION.ADD;this.$changes.indexes[e]=e,this.$indexes.set(e,e),this.$items.set(e,n),this.$changes.change(e,r)},e.prototype.deleteAt=function(t){var e=Array.from(this.$items.keys())[t];return void 0!==e&&this.$deleteAt(e)},e.prototype.$deleteAt=function(t){return this.$changes.delete(t),this.$indexes.delete(t),this.$items.delete(t)},e.prototype.clear=function(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&c.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:t.OPERATION.CLEAR}),this.$changes.touchParents()},e.prototype.concat=function(){for(var t,n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];return new(e.bind.apply(e,o([void 0],(t=Array.from(this.$items.values())).concat.apply(t,n),!1)))},e.prototype.join=function(t){return Array.from(this.$items.values()).join(t)},e.prototype.reverse=function(){var t=this,e=Array.from(this.$items.keys());return Array.from(this.$items.values()).reverse().forEach(function(n,i){t.setAt(e[i],n)}),this},e.prototype.shift=function(){var t=Array.from(this.$items.keys()).shift();if(void 0!==t){var e=this.$items.get(t);return this.$deleteAt(t),e}},e.prototype.slice=function(t,n){var i=new e;return i.push.apply(i,Array.from(this.$items.values()).slice(t,n)),i},e.prototype.sort=function(t){var e=this;void 0===t&&(t=f);var n=Array.from(this.$items.keys());return Array.from(this.$items.values()).sort(t).forEach(function(t,i){e.setAt(n[i],t)}),this},e.prototype.splice=function(t,e){void 0===e&&(e=this.length-t);for(var n=Array.from(this.$items.keys()),i=[],o=t;o<t+e;o++)i.push(this.$items.get(n[o])),this.$deleteAt(n[o]);return i},e.prototype.unshift=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var i=this.length,o=e.length,r=Array.from(this.$items.values());return e.forEach(function(e,n){t.setAt(n,e)}),r.forEach(function(e,n){t.setAt(o+n,e)}),i+o},e.prototype.indexOf=function(t,e){return Array.from(this.$items.values()).indexOf(t,e)},e.prototype.lastIndexOf=function(t,e){return void 0===e&&(e=this.length-1),Array.from(this.$items.values()).lastIndexOf(t,e)},e.prototype.every=function(t,e){return Array.from(this.$items.values()).every(t,e)},e.prototype.some=function(t,e){return Array.from(this.$items.values()).some(t,e)},e.prototype.forEach=function(t,e){Array.from(this.$items.values()).forEach(t,e)},e.prototype.map=function(t,e){return Array.from(this.$items.values()).map(t,e)},e.prototype.filter=function(t,e){return Array.from(this.$items.values()).filter(t,e)},e.prototype.reduce=function(t,e){return Array.prototype.reduce.apply(Array.from(this.$items.values()),arguments)},e.prototype.reduceRight=function(t,e){return Array.prototype.reduceRight.apply(Array.from(this.$items.values()),arguments)},e.prototype.find=function(t,e){return Array.from(this.$items.values()).find(t,e)},e.prototype.findIndex=function(t,e){return Array.from(this.$items.values()).findIndex(t,e)},e.prototype.fill=function(t,e,n){throw Error("ArraySchema#fill() not implemented")},e.prototype.copyWithin=function(t,e,n){throw Error("ArraySchema#copyWithin() not implemented")},e.prototype.toString=function(){return this.$items.toString()},e.prototype.toLocaleString=function(){return this.$items.toLocaleString()},e.prototype[Symbol.iterator]=function(){return Array.from(this.$items.values())[Symbol.iterator]()},e.prototype.entries=function(){return this.$items.entries()},e.prototype.keys=function(){return this.$items.keys()},e.prototype.values=function(){return this.$items.values()},e.prototype.includes=function(t,e){return Array.from(this.$items.values()).includes(t,e)},e.prototype.flatMap=function(t,e){throw Error("ArraySchema#flatMap() is not supported.")},e.prototype.flat=function(t){throw Error("ArraySchema#flat() is not supported.")},e.prototype.findLast=function(){var t=Array.from(this.$items.values());return t.findLast.apply(t,arguments)},e.prototype.findLastIndex=function(){var t=Array.from(this.$items.values());return t.findLastIndex.apply(t,arguments)},e.prototype.setIndex=function(t,e){this.$indexes.set(t,e)},e.prototype.getIndex=function(t){return this.$indexes.get(t)},e.prototype.getByIndex=function(t){return this.$items.get(this.$indexes.get(t))},e.prototype.deleteByIndex=function(t){var e=this.$indexes.get(t);this.$items.delete(e),this.$indexes.delete(t)},e.prototype.toArray=function(){return Array.from(this.$items.values())},e.prototype.toJSON=function(){return this.toArray().map(function(t){return"function"==typeof t.toJSON?t.toJSON():t})},e.prototype.clone=function(t){var n;return t?new(e.bind.apply(e,o([void 0],Array.from(this.$items.values()),!1))):new(e.bind.apply(e,o([void 0],this.map(function(t){return t.$changes?t.clone():t}),!1)))},e}(),h=function(){function e(t){var n=this;if(this.$changes=new r(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,t){if(t instanceof Map||t instanceof e)t.forEach(function(t,e){return n.set(e,t)});else for(var i in t)this.set(i,t[i])}}return e.prototype.onAdd=function(e,n){return void 0===n&&(n=!0),s(this.$callbacks||(this.$callbacks=[]),t.OPERATION.ADD,e,n?this.$items:void 0)},e.prototype.onRemove=function(e){return s(this.$callbacks||(this.$callbacks=[]),t.OPERATION.DELETE,e)},e.prototype.onChange=function(e){return s(this.$callbacks||(this.$callbacks=[]),t.OPERATION.REPLACE,e)},e.is=function(t){return void 0!==t.map},e.prototype[Symbol.iterator]=function(){return this.$items[Symbol.iterator]()},Object.defineProperty(e.prototype,Symbol.toStringTag,{get:function(){return this.$items[Symbol.toStringTag]},enumerable:!1,configurable:!0}),e.prototype.set=function(e,n){if(null==n)throw Error("MapSchema#set('".concat(e,"', ").concat(n,"): trying to set ").concat(n," value on '").concat(e,"'."));var i=void 0!==this.$changes.indexes[e],o=i?this.$changes.indexes[e]:this.$refId++,r=i?t.OPERATION.REPLACE:t.OPERATION.ADD,s=void 0!==n.$changes;return s&&n.$changes.setParent(this,this.$changes.root,o),i?s&&this.$items.get(e)!==n&&(r=t.OPERATION.ADD):(this.$changes.indexes[e]=o,this.$indexes.set(o,e)),this.$items.set(e,n),this.$changes.change(e,r),this},e.prototype.get=function(t){return this.$items.get(t)},e.prototype.delete=function(t){return this.$changes.delete(t),this.$items.delete(t)},e.prototype.clear=function(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&c.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:t.OPERATION.CLEAR}),this.$changes.touchParents()},e.prototype.has=function(t){return this.$items.has(t)},e.prototype.forEach=function(t){this.$items.forEach(t)},e.prototype.entries=function(){return this.$items.entries()},e.prototype.keys=function(){return this.$items.keys()},e.prototype.values=function(){return this.$items.values()},Object.defineProperty(e.prototype,"size",{get:function(){return this.$items.size},enumerable:!1,configurable:!0}),e.prototype.setIndex=function(t,e){this.$indexes.set(t,e)},e.prototype.getIndex=function(t){return this.$indexes.get(t)},e.prototype.getByIndex=function(t){return this.$items.get(this.$indexes.get(t))},e.prototype.deleteByIndex=function(t){var e=this.$indexes.get(t);this.$items.delete(e),this.$indexes.delete(t)},e.prototype.toJSON=function(){var t={};return this.forEach(function(e,n){t[n]="function"==typeof e.toJSON?e.toJSON():e}),t},e.prototype.clone=function(t){var n;return t?n=Object.assign(new e,this):(n=new e,this.forEach(function(t,e){t.$changes?n.set(e,t.clone()):n.set(e,t)})),n},e}(),d={};function l(t,e){d[t]=e}function $(t){return d[t]}var p=function(){function t(){this.indexes={},this.fieldsByIndex={},this.deprecated={},this.descriptors={}}return t.create=function(e){var n=new t;return n.schema=Object.assign({},e&&e.schema||{}),n.indexes=Object.assign({},e&&e.indexes||{}),n.fieldsByIndex=Object.assign({},e&&e.fieldsByIndex||{}),n.descriptors=Object.assign({},e&&e.descriptors||{}),n.deprecated=Object.assign({},e&&e.deprecated||{}),n},t.prototype.addField=function(t,e){var n=this.getNextFieldIndex();this.fieldsByIndex[n]=t,this.indexes[t]=n,this.schema[t]=Array.isArray(e)?{array:e[0]}:e},t.prototype.hasField=function(t){return void 0!==this.indexes[t]},t.prototype.addFilter=function(t,e){return this.filters||(this.filters={},this.indexesWithFilters=[]),this.filters[this.indexes[t]]=e,this.indexesWithFilters.push(this.indexes[t]),!0},t.prototype.addChildrenFilter=function(t,e){var n,i=this.indexes[t];if(d[n=Object.keys(this.schema[t])[0]])return this.childFilters||(this.childFilters={}),this.childFilters[i]=e,!0;console.warn("@filterChildren: field '".concat(t,"' can't have children. Ignoring filter."))},t.prototype.getChildrenFilter=function(t){return this.childFilters&&this.childFilters[this.indexes[t]]},t.prototype.getNextFieldIndex=function(){return Object.keys(this.schema||{}).length},t}(),v=function(){function t(){this.types={},this.schemas=new Map,this.useFilters=!1}return t.prototype.has=function(t){return this.schemas.has(t)},t.prototype.get=function(t){return this.types[t]},t.prototype.add=function(t,e){void 0===e&&(e=this.schemas.size),t._definition=p.create(t._definition),t._typeid=e,this.types[e]=t,this.schemas.set(t,e)},t.create=function(e){return void 0===e&&(e={}),function(n){return e.context||(e.context=new t),g(n,e)}},t}(),y=new v;function g(t,e){return void 0===e&&(e={}),function(n,i){var r=e.context||y,s=n.constructor;if(s._context=r,!t)throw Error("".concat(s.name,': @type() reference provided for "').concat(i,"\" is undefined. Make sure you don't have any circular dependencies."));r.has(s)||r.add(s);var c=s._definition;if(c.addField(i,t),c.descriptors[i]){if(c.deprecated[i])return;try{throw Error("@colyseus/schema: Duplicate '".concat(i,"' definition on '").concat(s.name,"'.\nCheck @type() annotation"))}catch(a){var f=a.stack.split("\n")[4].trim();throw Error("".concat(a.message," ").concat(f))}}var d=u.is(t),l=!d&&h.is(t);if("string"!=typeof t&&!tv.is(t)){var $=Object.values(t)[0];"string"==typeof $||r.has($)||r.add($)}if(e.manual){c.descriptors[i]={enumerable:!0,configurable:!0,writable:!0};return}var p="_".concat(i);c.descriptors[p]={enumerable:!1,configurable:!1,writable:!0},c.descriptors[i]={get:function(){return this[p]},set:function(t){if(t!==this[p]){if(null!=t){if(!d||t instanceof u||(t=new(u.bind.apply(u,o([void 0],t,!1)))),!l||t instanceof h||(t=new h(t)),void 0===t.$proxy){var e,n;l?t=((e=t).$proxy=!0,e=new Proxy(e,{get:function(t,e){return"symbol"!=typeof e&&void 0===t[e]?t.get(e):t[e]},set:function(t,e,n){return"symbol"!=typeof e&&-1===e.indexOf("$")&&"onAdd"!==e&&"onRemove"!==e&&"onChange"!==e?t.set(e,n):t[e]=n,!0},deleteProperty:function(t,e){return t.delete(e),!0}})):d&&(t=((n=t).$proxy=!0,n=new Proxy(n,{get:function(t,e){return"symbol"==typeof e||isNaN(e)?t[e]:t.at(e)},set:function(t,e,n){if("symbol"==typeof e||isNaN(e))t[e]=n;else{var i=parseInt(Array.from(t.$items.keys())[e]||e);null==n?t.deleteAt(i):t.setAt(i,n)}return!0},deleteProperty:function(t,e){return"number"==typeof e?t.deleteAt(e):delete t[e],!0}})))}this.$changes.change(i),t.$changes&&t.$changes.setParent(this,this.$changes.root,this._definition.indexes[i])}else this[p]&&this.$changes.delete(i);this[p]=t}},enumerable:!0,configurable:!0}}}function x(t,e,n){for(var i=0,o=0,r=n.length;o<r;o++)(i=n.charCodeAt(o))<128?t[e++]=i:i<2048?(t[e++]=192|i>>6,t[e++]=128|63&i):i<55296||i>=57344?(t[e++]=224|i>>12,t[e++]=128|i>>6&63,t[e++]=128|63&i):(o++,i=65536+((1023&i)<<10|1023&n.charCodeAt(o)),t[e++]=240|i>>18,t[e++]=128|i>>12&63,t[e++]=128|i>>6&63,t[e++]=128|63&i)}function m(t,e){t.push(255&e)}function E(t,e){t.push(255&e)}function _(t,e){t.push(255&e),t.push(e>>8&255)}function A(t,e){t.push(255&e),t.push(e>>8&255)}function O(t,e){t.push(255&e),t.push(e>>8&255),t.push(e>>16&255),t.push(e>>24&255)}function I(t,e){t.push(255&e),t.push(255&e>>8),t.push(255&e>>16),t.push(255&e>>24)}function w(t,e){I(t,e>>>0),I(t,Math.floor(e/4294967296))}function b(t,e){I(t,e>>>0),I(t,e/4294967296>>0)}function T(t,e){k(t,e)}function R(t,e){N(t,e)}var P=new Int32Array(2),C=new Float32Array(P.buffer),D=new Float64Array(P.buffer);function k(t,e){C[0]=e,O(t,P[0])}function N(t,e){D[0]=e,O(t,P[0]),O(t,P[1])}function S(t,e){e||(e="");var n=function t(e){for(var n=0,i=0,o=0,r=e.length;o<r;o++)(n=e.charCodeAt(o))<128?i+=1:n<2048?i+=2:n<55296||n>=57344?i+=3:(o++,i+=4);return i}(e),i=0;if(n<32)t.push(160|n),i=1;else if(n<256)t.push(217),E(t,n),i=2;else if(n<65536)t.push(218),A(t,n),i=3;else if(n<4294967296)t.push(219),I(t,n),i=5;else throw Error("String too long");return x(t,t.length,e),i+n}function M(t,e){return isNaN(e)?M(t,0):isFinite(e)?e!==(0|e)?(t.push(203),N(t,e),9):e>=0?e<128?(E(t,e),1):e<256?(t.push(204),E(t,e),2):e<65536?(t.push(205),A(t,e),3):e<4294967296?(t.push(206),I(t,e),5):(t.push(207),b(t,e),9):e>=-32?(t.push(224|e+32),1):e>=-128?(t.push(208),m(t,e),2):e>=-32768?(t.push(209),_(t,e),3):e>=-2147483648?(t.push(210),O(t,e),5):(t.push(211),w(t,e),9):M(t,e>0?Number.MAX_SAFE_INTEGER:-Number.MAX_SAFE_INTEGER)}var L=Object.freeze({__proto__:null,utf8Write:x,int8:m,uint8:E,int16:_,uint16:A,int32:O,uint32:I,int64:w,uint64:b,float32:T,float64:R,writeFloat32:k,writeFloat64:N,boolean:function t(e,n){return E(e,n?1:0)},string:S,number:M});function U(t,e){return F(t,e)<<24>>24}function F(t,e){return t[e.offset++]}function H(t,e){return B(t,e)<<16>>16}function B(t,e){return t[e.offset++]|t[e.offset++]<<8}function z(t,e){return t[e.offset++]|t[e.offset++]<<8|t[e.offset++]<<16|t[e.offset++]<<24}function V(t,e){return z(t,e)>>>0}function q(t,e){return X(t,e)}function J(t,e){return Q(t,e)}function j(t,e){var n=V(t,e);return 4294967296*z(t,e)+n}function K(t,e){var n=V(t,e);return 4294967296*V(t,e)+n}var W=new Int32Array(2),Y=new Float32Array(W.buffer),G=new Float64Array(W.buffer);function X(t,e){return W[0]=z(t,e),Y[0]}function Q(t,e){return W[0]=z(t,e),W[1]=z(t,e),G[0]}function Z(t,e){var n,i=t[e.offset++];i<192?n=31&i:217===i?n=F(t,e):218===i?n=B(t,e):219===i&&(n=V(t,e));var o=function t(e,n,i){for(var o="",r=0,s=n,c=n+i;s<c;s++){var a=e[s];if((128&a)==0){o+=String.fromCharCode(a);continue}if((224&a)==192){o+=String.fromCharCode((31&a)<<6|63&e[++s]);continue}if((240&a)==224){o+=String.fromCharCode((15&a)<<12|(63&e[++s])<<6|(63&e[++s])<<0);continue}if((248&a)==240){(r=(7&a)<<18|(63&e[++s])<<12|(63&e[++s])<<6|(63&e[++s])<<0)>=65536?(r-=65536,o+=String.fromCharCode((r>>>10)+55296,(1023&r)+56320)):o+=String.fromCharCode(r);continue}console.error("Invalid byte "+a.toString(16))}return o}(t,e.offset,n);return e.offset+=n,o}function tt(t,e){var n=t[e.offset++];if(n<128)return n;if(202===n)return X(t,e);if(203===n)return Q(t,e);if(204===n)return F(t,e);if(205===n)return B(t,e);else if(206===n)return V(t,e);else if(207===n)return K(t,e);else if(208===n)return U(t,e);else if(209===n)return H(t,e);else if(210===n)return z(t,e);else if(211===n)return j(t,e);else if(n>223)return-((255-n+1)*1)}function te(t,e){return 255===t[e.offset-1]&&(t[e.offset]<128||t[e.offset]>=202&&t[e.offset]<=211)}var tn=Object.freeze({__proto__:null,int8:U,uint8:F,int16:H,uint16:B,int32:z,uint32:V,float32:q,float64:J,int64:j,uint64:K,readFloat32:X,readFloat64:Q,boolean:function t(e,n){return F(e,n)>0},string:Z,stringCheck:function t(e,n){var i=e[n.offset];return i<192&&i>160||217===i||218===i||219===i},number:tt,numberCheck:function t(e,n){var i=e[n.offset];return i<128||i>=202&&i<=211},arrayCheck:function t(e,n){return e[n.offset]<160},switchStructureCheck:te}),ti=function(){function e(t){var e=this;this.$changes=new r(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,t&&t.forEach(function(t){return e.add(t)})}return e.prototype.onAdd=function(e,n){return void 0===n&&(n=!0),s(this.$callbacks||(this.$callbacks=[]),t.OPERATION.ADD,e,n?this.$items:void 0)},e.prototype.onRemove=function(e){return s(this.$callbacks||(this.$callbacks=[]),t.OPERATION.DELETE,e)},e.prototype.onChange=function(e){return s(this.$callbacks||(this.$callbacks=[]),t.OPERATION.REPLACE,e)},e.is=function(t){return void 0!==t.collection},e.prototype.add=function(t){var e=this.$refId++;return void 0!==t.$changes&&t.$changes.setParent(this,this.$changes.root,e),this.$changes.indexes[e]=e,this.$indexes.set(e,e),this.$items.set(e,t),this.$changes.change(e),e},e.prototype.at=function(t){var e=Array.from(this.$items.keys())[t];return this.$items.get(e)},e.prototype.entries=function(){return this.$items.entries()},e.prototype.delete=function(t){for(var e,n,i=this.$items.entries();(n=i.next())&&!n.done;)if(t===n.value[1]){e=n.value[0];break}return void 0!==e&&(this.$changes.delete(e),this.$indexes.delete(e),this.$items.delete(e))},e.prototype.clear=function(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&c.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:t.OPERATION.CLEAR}),this.$changes.touchParents()},e.prototype.has=function(t){return Array.from(this.$items.values()).some(function(e){return e===t})},e.prototype.forEach=function(t){var e=this;this.$items.forEach(function(n,i,o){return t(n,i,e)})},e.prototype.values=function(){return this.$items.values()},Object.defineProperty(e.prototype,"size",{get:function(){return this.$items.size},enumerable:!1,configurable:!0}),e.prototype.setIndex=function(t,e){this.$indexes.set(t,e)},e.prototype.getIndex=function(t){return this.$indexes.get(t)},e.prototype.getByIndex=function(t){return this.$items.get(this.$indexes.get(t))},e.prototype.deleteByIndex=function(t){var e=this.$indexes.get(t);this.$items.delete(e),this.$indexes.delete(t)},e.prototype.toArray=function(){return Array.from(this.$items.values())},e.prototype.toJSON=function(){var t=[];return this.forEach(function(e,n){t.push("function"==typeof e.toJSON?e.toJSON():e)}),t},e.prototype.clone=function(t){var n;return t?n=Object.assign(new e,this):(n=new e,this.forEach(function(t){t.$changes?n.add(t.clone()):n.add(t)})),n},e}(),to=function(){function e(t){var e=this;this.$changes=new r(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,t&&t.forEach(function(t){return e.add(t)})}return e.prototype.onAdd=function(e,n){return void 0===n&&(n=!0),s(this.$callbacks||(this.$callbacks=[]),t.OPERATION.ADD,e,n?this.$items:void 0)},e.prototype.onRemove=function(e){return s(this.$callbacks||(this.$callbacks=[]),t.OPERATION.DELETE,e)},e.prototype.onChange=function(e){return s(this.$callbacks||(this.$callbacks=[]),t.OPERATION.REPLACE,e)},e.is=function(t){return void 0!==t.set},e.prototype.add=function(e){if(this.has(e))return!1;var n,i,o=this.$refId++;void 0!==e.$changes&&e.$changes.setParent(this,this.$changes.root,o);var r=null!==(i=null===(n=this.$changes.indexes[o])||void 0===n?void 0:n.op)&&void 0!==i?i:t.OPERATION.ADD;return this.$changes.indexes[o]=o,this.$indexes.set(o,o),this.$items.set(o,e),this.$changes.change(o,r),o},e.prototype.entries=function(){return this.$items.entries()},e.prototype.delete=function(t){for(var e,n,i=this.$items.entries();(n=i.next())&&!n.done;)if(t===n.value[1]){e=n.value[0];break}return void 0!==e&&(this.$changes.delete(e),this.$indexes.delete(e),this.$items.delete(e))},e.prototype.clear=function(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&c.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:t.OPERATION.CLEAR}),this.$changes.touchParents()},e.prototype.has=function(t){for(var e,n=this.$items.values(),i=!1;(e=n.next())&&!e.done;)if(t===e.value){i=!0;break}return i},e.prototype.forEach=function(t){var e=this;this.$items.forEach(function(n,i,o){return t(n,i,e)})},e.prototype.values=function(){return this.$items.values()},Object.defineProperty(e.prototype,"size",{get:function(){return this.$items.size},enumerable:!1,configurable:!0}),e.prototype.setIndex=function(t,e){this.$indexes.set(t,e)},e.prototype.getIndex=function(t){return this.$indexes.get(t)},e.prototype.getByIndex=function(t){return this.$items.get(this.$indexes.get(t))},e.prototype.deleteByIndex=function(t){var e=this.$indexes.get(t);this.$items.delete(e),this.$indexes.delete(t)},e.prototype.toArray=function(){return Array.from(this.$items.values())},e.prototype.toJSON=function(){var t=[];return this.forEach(function(e,n){t.push("function"==typeof e.toJSON?e.toJSON():e)}),t},e.prototype.clone=function(t){var n;return t?n=Object.assign(new e,this):(n=new e,this.forEach(function(t){t.$changes?n.add(t.clone()):n.add(t)})),n},e}(),tr=function(){function t(){this.refIds=new WeakSet,this.containerIndexes=new WeakMap}return t.prototype.addRefId=function(t){this.refIds.has(t)||(this.refIds.add(t),this.containerIndexes.set(t,new Set))},t.get=function(e){return void 0===e.$filterState&&(e.$filterState=new t),e.$filterState},t}(),ts=function(){function t(){this.refs=new Map,this.refCounts={},this.deletedRefs=new Set,this.nextUniqueId=0}return t.prototype.getNextUniqueId=function(){return this.nextUniqueId++},t.prototype.addRef=function(t,e,n){void 0===n&&(n=!0),this.refs.set(t,e),n&&(this.refCounts[t]=(this.refCounts[t]||0)+1)},t.prototype.removeRef=function(t){this.refCounts[t]=this.refCounts[t]-1,this.deletedRefs.add(t)},t.prototype.clearRefs=function(){this.refs.clear(),this.deletedRefs.clear(),this.refCounts={}},t.prototype.garbageCollectDeletedRefs=function(){var t=this;this.deletedRefs.forEach(function(e){if(!(t.refCounts[e]>0)){var n=t.refs.get(e);if(n instanceof tv)for(var i in n._definition.schema)"string"!=typeof n._definition.schema[i]&&n[i]&&n[i].$changes&&t.removeRef(n[i].$changes.refId);else{var o=n.$changes.parent._definition;"function"==typeof Object.values(o.schema[o.fieldsByIndex[n.$changes.parentIndex]])[0]&&Array.from(n.values()).forEach(function(e){return t.removeRef(e.$changes.refId)})}t.refs.delete(e),delete t.refCounts[e]}}),this.deletedRefs.clear()},t}(),tc=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return n(e,t),e}(Error);function ta(t,e,n,i){if(!(t instanceof e))throw new tc("a '".concat(e.name,"' was expected, but '").concat(t.constructor.name,"' was provided in ").concat(n.constructor.name,"#").concat(i))}function tf(t,e,n,i,o){!function t(e,n,i,o){var r,s=!1;switch(n){case"number":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"float32":case"float64":r="number",isNaN(e)&&console.log('trying to encode "NaN" in '.concat(i.constructor.name,"#").concat(o));break;case"string":r="string",s=!0;break;case"boolean":return}if(typeof e!==r&&(!s||s&&null!==e)){var c="'".concat(JSON.stringify(e),"'").concat(e&&e.constructor&&" (".concat(e.constructor.name,")")||"");throw new tc("a '".concat(r,"' was expected, but ").concat(c," was provided in ").concat(i.constructor.name,"#").concat(o))}}(n,t,i,o);var r=L[t];if(r)r(e,n);else throw new tc("a '".concat(t,"' was expected, but ").concat(n," was provided in ").concat(i.constructor.name,"#").concat(o))}function tu(t,e,n){return tn[t](e,n)}var th,td,tl,t$,tp,tv=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];Object.defineProperties(this,{$changes:{value:new r(this,void 0,new ts),enumerable:!1,writable:!0},$callbacks:{value:void 0,enumerable:!1,writable:!0}});var n=this._definition.descriptors;n&&Object.defineProperties(this,n),t[0]&&this.assign(t[0])}return e.onError=function(t){console.error(t)},e.is=function(t){return t._definition&&void 0!==t._definition.schema},e.prototype.onChange=function(e){return s(this.$callbacks||(this.$callbacks=[]),t.OPERATION.REPLACE,e)},e.prototype.onRemove=function(e){return s(this.$callbacks||(this.$callbacks=[]),t.OPERATION.DELETE,e)},e.prototype.assign=function(t){return Object.assign(this,t),this},Object.defineProperty(e.prototype,"_definition",{get:function(){return this.constructor._definition},enumerable:!1,configurable:!0}),e.prototype.setDirty=function(t,e){this.$changes.change(t,e)},e.prototype.listen=function(t,e,n){var i=this;return void 0===n&&(n=!0),this.$callbacks||(this.$callbacks={}),this.$callbacks[t]||(this.$callbacks[t]=[]),this.$callbacks[t].push(e),n&&void 0!==this[t]&&e(this[t],void 0),function(){return a(i.$callbacks[t],i.$callbacks[t].indexOf(e))}},e.prototype.decode=function(n,i,o){void 0===i&&(i={offset:0}),void 0===o&&(o=this);var r,s=[],c=this.$changes.root,a=n.length,f=0;for(c.refs.set(f,this);i.offset<a;){var l=n[i.offset++];if(255==l){f=tt(n,i);var $=c.refs.get(f);if(!$)throw Error('"refId" not found: '.concat(f));o=$;continue}var p=o.$changes,v=void 0!==o._definition,y=v?l>>6<<6:l;if(y===t.OPERATION.CLEAR){o.clear(s);continue}var g=v?l%(y||255):tt(n,i),x=v?o._definition.fieldsByIndex[g]:"",m=p.getType(g),E=void 0,_=void 0,A=void 0;if(v?_=o["_".concat(x)]:(_=o.getByIndex(g),(y&t.OPERATION.ADD)===t.OPERATION.ADD?(A=o instanceof h?Z(n,i):g,o.setIndex(g,A)):A=o.getIndex(g)),(y&t.OPERATION.DELETE)===t.OPERATION.DELETE&&(y!==t.OPERATION.DELETE_AND_ADD&&o.deleteByIndex(g),_&&_.$changes&&c.removeRef(_.$changes.refId),E=null),void 0===x){console.warn("@colyseus/schema: definition mismatch");for(var O={offset:i.offset};i.offset<a&&!(te(n,i)&&(O.offset=i.offset+1,c.refs.has(tt(n,O))));)i.offset++;continue}if(y===t.OPERATION.DELETE);else if(e.is(m)){var I=tt(n,i);if(E=c.refs.get(I),y!==t.OPERATION.REPLACE){var w=this.getSchemaType(n,i,m);!E&&((E=this.createTypeInstance(w)).$changes.refId=I,_&&(E.$callbacks=_.$callbacks,_.$changes.refId&&I!==_.$changes.refId&&c.removeRef(_.$changes.refId))),c.addRef(I,E,E!==_)}}else if("string"==typeof m)E=tu(m,n,i);else{var b,T=d[b=Object.keys(m)[0]],R=tt(n,i),P=c.refs.has(R)?_||c.refs.get(R):new T.constructor;if((E=P.clone(!0)).$changes.refId=R,_&&(E.$callbacks=_.$callbacks,_.$changes.refId&&R!==_.$changes.refId)){c.removeRef(_.$changes.refId);for(var C=_.entries(),D=void 0;(D=C.next())&&!D.done;){var k=(r=D.value)[0],N=r[1];s.push({refId:R,op:t.OPERATION.DELETE,field:k,value:void 0,previousValue:N})}}c.addRef(R,E,P!==_)}if(null!=E){if(E.$changes&&E.$changes.setParent(p.ref,p.root,g),o instanceof e)o[x]=E;else if(o instanceof h){var k=A;o.$items.set(k,E),o.$changes.allChanges.add(g)}else if(o instanceof u)o.setAt(g,E);else if(o instanceof ti){var S=o.add(E);o.setIndex(g,S)}else if(o instanceof to){var S=o.add(E);!1!==S&&o.setIndex(g,S)}}_!==E&&s.push({refId:f,op:y,field:x,dynamicIndex:A,value:E,previousValue:_})}return this._triggerChanges(s),c.garbageCollectDeletedRefs(),s},e.prototype.encode=function(n,i,o){void 0===n&&(n=!1),void 0===i&&(i=[]),void 0===o&&(o=!1);for(var r=this.$changes,s=new WeakSet,c=[r],a=1,f=0;f<a;f++){var u=c[f],l=u.ref,$=l instanceof e;u.ensureRefId(),s.add(u),u!==r&&(u.changed||n)&&(E(i,255),M(i,u.refId));for(var p=n?Array.from(u.allChanges):Array.from(u.changes.values()),v=0,y=p.length;v<y;v++){var g=n?{op:t.OPERATION.ADD,index:p[v]}:p[v],x=g.index,m=$?l._definition.fieldsByIndex&&l._definition.fieldsByIndex[x]:x,_=i.length;if(g.op!==t.OPERATION.TOUCH){if($)E(i,x|g.op);else{if(E(i,g.op),g.op===t.OPERATION.CLEAR)continue;M(i,x)}}if(!$&&(g.op&t.OPERATION.ADD)==t.OPERATION.ADD&&l instanceof h){S(i,u.ref.$indexes.get(x))}if(g.op!==t.OPERATION.DELETE){var A=u.getType(x),O=u.getValue(x);if(O&&O.$changes&&!s.has(O.$changes)&&(c.push(O.$changes),O.$changes.ensureRefId(),a++),g.op!==t.OPERATION.TOUCH){if(e.is(A))ta(O,A,l,m),M(i,O.$changes.refId),(g.op&t.OPERATION.ADD)===t.OPERATION.ADD&&this.tryEncodeTypeId(i,A,O.constructor);else if("string"==typeof A)tf(A,i,O,l,m);else{var I,w,b=d[w=Object.keys(A)[0]];ta(l["_".concat(m)],b.constructor,l,m),M(i,O.$changes.refId)}o&&u.cache(x,i.slice(_))}}}n||o||u.discard()}return i},e.prototype.encodeAll=function(t){return this.encode(!0,[],t)},e.prototype.applyFilters=function(n,i){void 0===i&&(i=!1);for(var o,r,s=this,c=new Set,a=tr.get(n),f=[this.$changes],u=1,d=[],l=0;l<u;l++)!function(l){var $=f[l];if(c.has($.refId))return"continue";var p=$.ref,v=p instanceof e;E(d,255),M(d,$.refId);var y=a.refIds.has($),g=i||!y;a.addRefId($);var x=a.containerIndexes.get($),m=g?Array.from($.allChanges):Array.from($.changes.values());!i&&v&&p._definition.indexesWithFilters&&p._definition.indexesWithFilters.forEach(function(e){!x.has(e)&&$.allChanges.has(e)&&(g?m.push(e):m.push({op:t.OPERATION.ADD,index:e}))});for(var _=0,A=m.length;_<A;_++){var O=g?{op:t.OPERATION.ADD,index:m[_]}:m[_];if(O.op===t.OPERATION.CLEAR){E(d,O.op);continue}var I=O.index;if(O.op===t.OPERATION.DELETE){v?E(d,O.op|I):(E(d,O.op),M(d,I));continue}var w=$.getValue(I),b=$.getType(I);if(v){var T=p._definition.filters&&p._definition.filters[I];if(T&&!T.call(p,n,w,s)){w&&w.$changes&&c.add(w.$changes.refId);continue}}else{var R=$.parent,T=$.getChildrenFilter();if(T&&!T.call(R,n,p.$indexes.get(I),w,s)){w&&w.$changes&&c.add(w.$changes.refId);continue}}if(w.$changes&&(f.push(w.$changes),u++),O.op!==t.OPERATION.TOUCH){if(O.op===t.OPERATION.ADD||v)d.push.apply(d,null!==(o=$.caches[I])&&void 0!==o?o:[]),x.add(I);else if(x.has(I))d.push.apply(d,null!==(r=$.caches[I])&&void 0!==r?r:[]);else{if(x.add(I),E(d,t.OPERATION.ADD),M(d,I),p instanceof h){var P=$.ref.$indexes.get(I);S(d,P)}w.$changes?M(d,w.$changes.refId):L[b](d,w)}}else if(w.$changes&&!v){if(E(d,t.OPERATION.ADD),M(d,I),p instanceof h){var P=$.ref.$indexes.get(I);S(d,P)}M(d,w.$changes.refId)}}}(l);return d},e.prototype.clone=function(){var t,e=new this.constructor,n=this._definition.schema;for(var i in n)"object"==typeof this[i]&&"function"==typeof(null===(t=this[i])||void 0===t?void 0:t.clone)?e[i]=this[i].clone():e[i]=this[i];return e},e.prototype.toJSON=function(){var t=this._definition.schema,e=this._definition.deprecated,n={};for(var i in t)e[i]||null===this[i]||void 0===this[i]||(n[i]="function"==typeof this[i].toJSON?this[i].toJSON():this["_".concat(i)]);return n},e.prototype.discardAllChanges=function(){this.$changes.discardAll()},e.prototype.getByIndex=function(t){return this[this._definition.fieldsByIndex[t]]},e.prototype.deleteByIndex=function(t){this[this._definition.fieldsByIndex[t]]=void 0},e.prototype.tryEncodeTypeId=function(t,e,n){e._typeid!==n._typeid&&(E(t,213),M(t,n._typeid))},e.prototype.getSchemaType=function(t,e,n){var i;return 213===t[e.offset]&&(e.offset++,i=this.constructor._context.get(tt(t,e))),i||n},e.prototype.createTypeInstance=function(t){var e=new t;return e.$changes.root=this.$changes.root,e},e.prototype._triggerChanges=function(n){for(var i,o,r,s,c,a,f,u,h,d=new Set,l=this.$changes.root.refs,$=0;$<n.length;$++)!function($){var p=n[$],v=p.refId,y=l.get(v),g=y.$callbacks;if((p.op&t.OPERATION.DELETE)===t.OPERATION.DELETE&&p.previousValue instanceof e&&(null===(o=null===(i=p.previousValue.$callbacks)||void 0===i?void 0:i[t.OPERATION.DELETE])||void 0===o||o.forEach(function(t){return t()})),!g)return"continue";if(y instanceof e){if(!d.has(v))try{null===(r=null==g?void 0:g[t.OPERATION.REPLACE])||void 0===r||r.forEach(function(t){return t(n)})}catch(x){e.onError(x)}try{g.hasOwnProperty(p.field)&&(null===(s=g[p.field])||void 0===s||s.forEach(function(t){return t(p.value,p.previousValue)}))}catch(m){e.onError(m)}}else p.op===t.OPERATION.ADD&&void 0===p.previousValue?null===(c=g[t.OPERATION.ADD])||void 0===c||c.forEach(function(t){var e;return t(p.value,null!==(e=p.dynamicIndex)&&void 0!==e?e:p.field)}):p.op===t.OPERATION.DELETE?void 0!==p.previousValue&&(null===(a=g[t.OPERATION.DELETE])||void 0===a||a.forEach(function(t){var e;return t(p.previousValue,null!==(e=p.dynamicIndex)&&void 0!==e?e:p.field)})):p.op===t.OPERATION.DELETE_AND_ADD&&(void 0!==p.previousValue&&(null===(f=g[t.OPERATION.DELETE])||void 0===f||f.forEach(function(t){var e;return t(p.previousValue,null!==(e=p.dynamicIndex)&&void 0!==e?e:p.field)})),null===(u=g[t.OPERATION.ADD])||void 0===u||u.forEach(function(t){var e;return t(p.value,null!==(e=p.dynamicIndex)&&void 0!==e?e:p.field)})),p.value!==p.previousValue&&(null===(h=g[t.OPERATION.REPLACE])||void 0===h||h.forEach(function(t){var e;return t(p.value,null!==(e=p.dynamicIndex)&&void 0!==e?e:p.field)}));d.add(v)}($)},e._definition=p.create(),e}(),ty={context:new v},tg=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return n(e,t),i([g("string",ty)],e.prototype,"name",void 0),i([g("string",ty)],e.prototype,"type",void 0),i([g("number",ty)],e.prototype,"referencedType",void 0),e}(tv),tx=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.fields=new u,e}return n(e,t),i([g("number",ty)],e.prototype,"id",void 0),i([g([tg],ty)],e.prototype,"fields",void 0),e}(tv),tm=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.types=new u,e}return n(e,t),e.encode=function(t){var n=t.constructor,i=new e;i.rootType=n._typeid;var o=n._context.types;for(var r in o){var s=new tx;s.id=Number(r),function(t,e){for(var n in e){var o=new tg;o.name=n;var r=void 0;if("string"==typeof e[n])r=e[n];else{var s=e[n],c=void 0;tv.is(s)?(r="ref",c=e[n]):"string"==typeof s[r=Object.keys(s)[0]]?r+=":"+s[r]:c=s[r],o.referencedType=c?c._typeid:-1}o.type=r,t.fields.push(o)}i.types.push(t)}(s,o[r]._definition.schema)}return i.encodeAll()},e.decode=function(t,i){var o=new v,r=new e;r.decode(t,i);var s=r.types.reduce(function(t,e){var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return n(e,t),e}(tv),r=e.id;return t[r]=i,o.add(i,r),t},{});r.types.forEach(function(t){var e=s[t.id];t.fields.forEach(function(t){var n;if(void 0!==t.referencedType){var i=t.type,r=s[t.referencedType];if(!r){var c=t.type.split(":");i=c[0],r=c[1]}"ref"===i?g(r,{context:o})(e.prototype,t.name):g(((n={})[i]=r,n),{context:o})(e.prototype,t.name)}else g(t.type,{context:o})(e.prototype,t.name)})});var c=s[r.rootType],a=new c;for(var f in c._definition.schema){var u,h=c._definition.schema[f];"string"!=typeof h&&(a[f]="function"==typeof h?new h:new d[u=Object.keys(h)[0]].constructor)}return a},i([g([tx],ty)],e.prototype,"types",void 0),i([g("number",ty)],e.prototype,"rootType",void 0),e}(tv);td={constructor:h},d.map=td,tl={constructor:u},d.array=tl,t$={constructor:to},d.set=t$,tp={constructor:ti},d.collection=tp,t.ArraySchema=u,t.CollectionSchema=ti,t.Context=v,t.MapSchema=h,t.Reflection=tm,t.ReflectionField=tg,t.ReflectionType=tx,t.Schema=tv,t.SchemaDefinition=p,t.SetSchema=to,t.decode=tn,t.defineTypes=function t(e,n,i){for(var o in void 0===i&&(i={}),i.context||(i.context=e._context||i.context||y),n)g(n[o],i)(e.prototype,o);return e},t.deprecated=function t(e){return void 0===e&&(e=!0),function(t,n){var i=t.constructor._definition;i.deprecated[n]=!0,e&&(i.descriptors[n]={get:function(){throw Error("".concat(n," is deprecated."))},set:function(t){},enumerable:!1,configurable:!0})}},t.dumpChanges=function t(e){for(var n=[e.$changes],i={},o=i,r=0;r<1;r++)!function(t){var e=n[t];e.changes.forEach(function(t){var n=e.ref,i=t.index;o[n._definition?n._definition.fieldsByIndex[i]:n.$indexes.get(i)]=e.getValue(i)})}(r);return i},t.encode=L,t.filter=function t(e){return function(t,n){var i=t.constructor;i._definition.addFilter(n,e)&&(i._context.useFilters=!0)}},t.filterChildren=function t(e){return function(t,n){var i=t.constructor;i._definition.addChildrenFilter(n,e)&&(i._context.useFilters=!0)}},t.hasFilter=function t(e){return e._context&&e._context.useFilters},t.registerType=l,t.type=g,Object.defineProperty(t,"__esModule",{value:!0})})(e)})(V,V.exports),V.exports),j=function(){function n(t,e){var n=this;this.onStateChange=B(),this.onError=B(),this.onLeave=B(),this.onJoin=B(),this.hasJoined=!1,this.onMessageHandlers={emit:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var i=this.events[t]||[],o=0,r=i.length;o<r;o++)i[o].apply(i,e)},events:{},on:function(t,e){var n,i=this;return(null===(n=this.events[t])||void 0===n?void 0:n.push(e))||(this.events[t]=[e]),function(){var n;i.events[t]=null===(n=i.events[t])||void 0===n?void 0:n.filter(function(t){return e!==t})}}},this.roomId=null,this.name=t,e&&(this.serializer=new(F("schema")),this.rootSchema=e,this.serializer.state=new e),this.onError(function(t,e){var n;return null===(n=console.warn)||void 0===n?void 0:n.call(console,"colyseus.js - onError => (".concat(t,") ").concat(e))}),this.onLeave(function(){return n.removeAllListeners()})}return Object.defineProperty(n.prototype,"id",{get:function(){return this.roomId},enumerable:!1,configurable:!0}),n.prototype.connect=function(t,i,o){void 0===o&&(o=this);var r=new N;o.connection=r,r.events.onmessage=n.prototype.onMessageCallback.bind(o),r.events.onclose=function(t){var n;if(!o.hasJoined){null===(n=console.warn)||void 0===n||n.call(console,"Room connection was closed unexpectedly (".concat(t.code,"): ").concat(t.reason)),o.onError.invoke(t.code,t.reason);return}t.code===e.DEVMODE_RESTART&&i?i():(o.onLeave.invoke(t.code),o.destroy())},r.events.onerror=function(t){var e;null===(e=console.warn)||void 0===e||e.call(console,"Room, onError (".concat(t.code,"): ").concat(t.reason)),o.onError.invoke(t.code,t.reason)},r.connect(t)},n.prototype.leave=function(n){var i=this;return void 0===n&&(n=!0),new Promise(function(o){i.onLeave(function(t){return o(t)}),i.connection?n?i.connection.send([t.Protocol.LEAVE_ROOM]):i.connection.close():i.onLeave.invoke(e.CONSENTED)})},n.prototype.onMessage=function(t,e){return this.onMessageHandlers.on(this.getMessageHandlerKey(t),e)},n.prototype.send=function(e,n){var i,o=[t.Protocol.ROOM_DATA];if("string"==typeof e?J.encode.string(o,e):J.encode.number(o,e),void 0!==n){var r=function t(e){var n=[],i=[],o=function t(e,n,i){var o=typeof i,r=0,s=0,c=0,a=0,f=0,u=0;if("string"===o){if((f=function t(e){for(var n=0,i=0,o=0,r=e.length;o<r;o++)(n=e.charCodeAt(o))<128?i+=1:n<2048?i+=2:n<55296||n>=57344?i+=3:(o++,i+=4);return i}(i))<32)e.push(160|f),u=1;else if(f<256)e.push(217,f),u=2;else if(f<65536)e.push(218,f>>8,f),u=3;else if(f<4294967296)e.push(219,f>>24,f>>16,f>>8,f),u=5;else throw Error("String too long");return n.push({_str:i,_length:f,_offset:e.length}),u+f}if("number"===o)return Math.floor(i)===i&&isFinite(i)?i>=0?i<128?(e.push(i),1):i<256?(e.push(204,i),2):i<65536?(e.push(205,i>>8,i),3):i<4294967296?(e.push(206,i>>24,i>>16,i>>8,i),5):(c=i/4294967296>>0,a=i>>>0,e.push(207,c>>24,c>>16,c>>8,c,a>>24,a>>16,a>>8,a),9):i>=-32?(e.push(i),1):i>=-128?(e.push(208,i),2):i>=-32768?(e.push(209,i>>8,i),3):i>=-2147483648?(e.push(210,i>>24,i>>16,i>>8,i),5):(c=Math.floor(i/4294967296),a=i>>>0,e.push(211,c>>24,c>>16,c>>8,c,a>>24,a>>16,a>>8,a),9):(e.push(203),n.push({_float:i,_length:8,_offset:e.length}),9);if("object"===o){if(null===i)return e.push(192),1;if(Array.isArray(i)){if((f=i.length)<16)e.push(144|f),u=1;else if(f<65536)e.push(220,f>>8,f),u=3;else if(f<4294967296)e.push(221,f>>24,f>>16,f>>8,f),u=5;else throw Error("Array too large");for(r=0;r<f;r++)u+=t(e,n,i[r]);return u}if(i instanceof Date){var h=i.getTime(),d=Math.floor(h/1e3),l=(h-1e3*d)*1e6;return d>=0&&l>=0&&d<=17179869183?0===l&&d<=4294967295?(e.push(214,255,d>>24,d>>16,d>>8,d),6):(c=d/4294967296,a=4294967295&d,e.push(215,255,l>>22,l>>14,l>>6,c,a>>24,a>>16,a>>8,a),10):(c=Math.floor(d/4294967296),a=d>>>0,e.push(199,12,255,l>>24,l>>16,l>>8,l,c>>24,c>>16,c>>8,c,a>>24,a>>16,a>>8,a),15)}if(i instanceof ArrayBuffer){if((f=i.byteLength)<256)e.push(196,f),u=2;else if(f<65536)e.push(197,f>>8,f),u=3;else if(f<4294967296)e.push(198,f>>24,f>>16,f>>8,f),u=5;else throw Error("Buffer too large");return n.push({_bin:i,_length:f,_offset:e.length}),u+f}if("function"==typeof i.toJSON)return t(e,n,i.toJSON());var $=[],p="",v=Object.keys(i);for(r=0,s=v.length;r<s;r++)void 0!==i[p=v[r]]&&"function"!=typeof i[p]&&$.push(p);if((f=$.length)<16)e.push(128|f),u=1;else if(f<65536)e.push(222,f>>8,f),u=3;else if(f<4294967296)e.push(223,f>>24,f>>16,f>>8,f),u=5;else throw Error("Object too large");for(r=0;r<f;r++)u+=t(e,n,p=$[r]),u+=t(e,n,i[p]);return u}if("boolean"===o)return e.push(i?195:194),1;if("undefined"===o)return e.push(192),1;if("function"==typeof i.toJSON)return t(e,n,i.toJSON());throw Error("Could not encode")}(n,i,e),r=new ArrayBuffer(o),s=new DataView(r),c=0,a=0,f=-1;i.length>0&&(f=i[0]._offset);for(var u,h=0,d=0,l=0,$=n.length;l<$;l++)if(s.setUint8(a+l,n[l]),l+1===f){if(h=(u=i[c])._length,d=a+f,u._bin)for(var p=new Uint8Array(u._bin),v=0;v<h;v++)s.setUint8(d+v,p[v]);else u._str?T(s,d,u._str):void 0!==u._float&&s.setFloat64(d,u._float);c++,a+=h,i[c]&&(f=i[c]._offset)}return r}(n);(i=new Uint8Array(o.length+r.byteLength)).set(new Uint8Array(o),0),i.set(new Uint8Array(r),o.length)}else i=new Uint8Array(o);this.connection.send(i.buffer)},n.prototype.sendBytes=function(e,n){var i,o=[t.Protocol.ROOM_DATA_BYTES];"string"==typeof e?J.encode.string(o,e):J.encode.number(o,e),(i=new Uint8Array(o.length+(n.byteLength||n.length))).set(new Uint8Array(o),0),i.set(new Uint8Array(n),o.length),this.connection.send(i.buffer)},Object.defineProperty(n.prototype,"state",{get:function(){return this.serializer.getState()},enumerable:!1,configurable:!0}),n.prototype.removeAllListeners=function(){this.onJoin.clear(),this.onStateChange.clear(),this.onError.clear(),this.onLeave.clear(),this.onMessageHandlers.events={}},n.prototype.onMessageCallback=function(e){var n=Array.from(new Uint8Array(e.data)),i=n[0];if(i===t.Protocol.JOIN_ROOM){var o=1,r=S(n,o);if(o+=M(r),this.serializerId=S(n,o),o+=M(this.serializerId),!this.serializer){var s=F(this.serializerId);this.serializer=new s}n.length>o&&this.serializer.handshake&&this.serializer.handshake(n,{offset:o}),this.reconnectionToken="".concat(this.roomId,":").concat(r),this.hasJoined=!0,this.onJoin.invoke(),this.connection.send([t.Protocol.JOIN_ROOM])}else if(i===t.Protocol.ERROR){var c={offset:1},a=J.decode.number(n,c),f=J.decode.string(n,c);this.onError.invoke(a,f)}else if(i===t.Protocol.LEAVE_ROOM)this.leave();else if(i===t.Protocol.ROOM_DATA_SCHEMA){var u={offset:1},h=this.serializer.getState().constructor._context.get(J.decode.number(n,u)),f=new h;f.decode(n,u),this.dispatchMessage(h,f)}else if(i===t.Protocol.ROOM_STATE)n.shift(),this.setState(n);else if(i===t.Protocol.ROOM_STATE_PATCH)n.shift(),this.patch(n);else if(i===t.Protocol.ROOM_DATA){var d={offset:1},h=J.decode.stringCheck(n,d)?J.decode.string(n,d):J.decode.number(n,d),f=n.length>d.offset?function t(e,n){void 0===n&&(n=0);var i=new b(e,n),o=i._parse();if(i._offset!==e.byteLength)throw Error(e.byteLength-i._offset+" trailing bytes");return o}(e.data,d.offset):void 0;this.dispatchMessage(h,f)}else if(i===t.Protocol.ROOM_DATA_BYTES){var l={offset:1},h=J.decode.stringCheck(n,l)?J.decode.string(n,l):J.decode.number(n,l);this.dispatchMessage(h,new Uint8Array(n.slice(l.offset)))}},n.prototype.setState=function(t){this.serializer.setState(t),this.onStateChange.invoke(this.serializer.getState())},n.prototype.patch=function(t){this.serializer.patch(t),this.onStateChange.invoke(this.serializer.getState())},n.prototype.dispatchMessage=function(t,e){var n,i=this.getMessageHandlerKey(t);this.onMessageHandlers.events[i]?this.onMessageHandlers.emit(i,e):this.onMessageHandlers.events["*"]?this.onMessageHandlers.emit("*",t,e):null===(n=console.warn)||void 0===n||n.call(console,"colyseus.js: onMessage() not registered for type '".concat(t,"'."))},n.prototype.destroy=function(){this.serializer&&this.serializer.teardown()},n.prototype.getMessageHandlerKey=function(t){switch(typeof t){case"function":return"$".concat(t._typeid);case"string":return t;case"number":return"i".concat(t);default:throw Error("invalid message type.")}},n}(),K=function(t){function e(n,i){var o=t.call(this,n)||this;return o.code=i,Object.setPrototypeOf(o,e.prototype),o}return r(e,t),e}(Error),W="undefined"!=typeof window&&void 0!==(null===(n=null==window?void 0:window.location)||void 0===n?void 0:n.hostname)?"".concat(window.location.protocol.replace("http","ws"),"//").concat(window.location.hostname).concat(window.location.port&&":".concat(window.location.port)):"ws://127.0.0.1:2567",Y=function(){function t(t){if(void 0===t&&(t=W),"string"==typeof t){var e=new URL(t),n="https:"===e.protocol||"wss:"===e.protocol,i=Number(e.port||(n?443:80));this.settings={hostname:e.hostname,pathname:"/"!==e.pathname?e.pathname:"",port:i,secure:n}}else void 0===t.port&&(t.port=t.secure?443:80),void 0===t.pathname&&(t.pathname=""),this.settings=t}return t.prototype.joinOrCreate=function(t,e,n){return void 0===e&&(e={}),s(this,void 0,void 0,function(){return c(this,function(i){switch(i.label){case 0:return[4,this.createMatchMakeRequest("joinOrCreate",t,e,n)];case 1:return[2,i.sent()]}})})},t.prototype.create=function(t,e,n){return void 0===e&&(e={}),s(this,void 0,void 0,function(){return c(this,function(i){switch(i.label){case 0:return[4,this.createMatchMakeRequest("create",t,e,n)];case 1:return[2,i.sent()]}})})},t.prototype.join=function(t,e,n){return void 0===e&&(e={}),s(this,void 0,void 0,function(){return c(this,function(i){switch(i.label){case 0:return[4,this.createMatchMakeRequest("join",t,e,n)];case 1:return[2,i.sent()]}})})},t.prototype.joinById=function(t,e,n){return void 0===e&&(e={}),s(this,void 0,void 0,function(){return c(this,function(i){switch(i.label){case 0:return[4,this.createMatchMakeRequest("joinById",t,e,n)];case 1:return[2,i.sent()]}})})},t.prototype.reconnect=function(t,e){return s(this,void 0,void 0,function(){var n,i,o;return c(this,function(r){switch(r.label){case 0:if("string"==typeof t&&"string"==typeof e)throw Error("DEPRECATED: .reconnect() now only accepts 'reconnectionToken' as argument.\nYou can get this token from previously connected `room.reconnectionToken`");return i=(n=t.split(":"))[0],o=n[1],[4,this.createMatchMakeRequest("reconnect",i,{reconnectionToken:o},e)];case 1:return[2,r.sent()]}})})},t.prototype.getAvailableRooms=function(t){return void 0===t&&(t=""),s(this,void 0,void 0,function(){return c(this,function(e){switch(e.label){case 0:return[4,x(this.getHttpEndpoint("".concat(t)),{headers:{Accept:"application/json"}})];case 1:return[2,e.sent().data]}})})},t.prototype.consumeSeatReservation=function(t,e,n){return s(this,void 0,void 0,function(){var i,o,r,a=this;return c(this,function(f){return(i=this.createRoom(t.room.name,e)).roomId=t.room.roomId,i.sessionId=t.sessionId,o={sessionId:i.sessionId},t.reconnectionToken&&(o.reconnectionToken=t.reconnectionToken),r=n||i,i.connect(this.buildEndpoint(t.room,o),t.devMode&&function(){return s(a,void 0,void 0,function(){var n,o,a,f=this;return c(this,function(u){return console.info("[Colyseus devMode]: ".concat(String.fromCodePoint(128260)," Re-establishing connection with room id '").concat(i.roomId,"'...")),n=0,o=8,a=function(){return s(f,void 0,void 0,function(){return c(this,function(s){switch(s.label){case 0:n++,s.label=1;case 1:return s.trys.push([1,3,,4]),[4,this.consumeSeatReservation(t,e,r)];case 2:return s.sent(),console.info("[Colyseus devMode]: ".concat(String.fromCodePoint(9989)," Successfully re-established connection with room '").concat(i.roomId,"'")),[3,4];case 3:return s.sent(),n<o?(console.info("[Colyseus devMode]: ".concat(String.fromCodePoint(128260)," retrying... (").concat(n," out of ").concat(o,")")),setTimeout(a,2e3)):console.info("[Colyseus devMode]: ".concat(String.fromCodePoint(10060)," Failed to reconnect. Is your server running? Please check server logs.")),[3,4];case 4:return[2]}})})},setTimeout(a,2e3),[2]})})},r),[2,new Promise(function(t,e){var n=function(t,n){return e(new w(t,n))};r.onError.once(n),r.onJoin.once(function(){r.onError.remove(n),t(r)})})]})})},t.prototype.createMatchMakeRequest=function(t,e,n,i,o){return void 0===n&&(n={}),s(this,void 0,void 0,function(){var r;return c(this,function(s){switch(s.label){case 0:return[4,E(this.getHttpEndpoint("".concat(t,"/").concat(e)),{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(n)})];case 1:if((r=s.sent().data).error)throw new K(r.error,r.code);return"reconnect"===t&&(r.reconnectionToken=n.reconnectionToken),[4,this.consumeSeatReservation(r,i,o)];case 2:return[2,s.sent()]}})})},t.prototype.createRoom=function(t,e){return new j(t,e)},t.prototype.buildEndpoint=function(t,e){void 0===e&&(e={});var n=[];for(var i in e)e.hasOwnProperty(i)&&n.push("".concat(i,"=").concat(e[i]));var o=this.settings.secure?"wss://":"ws://";return t.publicAddress?o+="".concat(t.publicAddress):o+="".concat(this.settings.hostname).concat(this.getEndpointPort()).concat(this.settings.pathname),"".concat(o,"/").concat(t.processId,"/").concat(t.roomId,"?").concat(n.join("&"))},t.prototype.getHttpEndpoint=function(t){return void 0===t&&(t=""),"".concat(this.settings.secure?"https":"http","://").concat(this.settings.hostname).concat(this.getEndpointPort()).concat(this.settings.pathname,"/matchmake/").concat(t)},t.prototype.getEndpointPort=function(){return 80!==this.settings.port&&443!==this.settings.port?":".concat(this.settings.port):""},t}();function G(){return i||(i="undefined"!=typeof cc&&cc.sys&&cc.sys.localStorage?cc.sys.localStorage:"undefined"!=typeof window&&window.localStorage?window.localStorage:{cache:{},setItem:function(t,e){this.cache[t]=e},getItem:function(t){this.cache[t]},removeItem:function(t){delete this.cache[t]}}),i}var X,Q="colyseus-auth-token";t.Platform=void 0,(X=t.Platform||(t.Platform={})).ios="ios",X.android="android";var Z,tt,te=function(){function t(t){var e,n,i,o=this;this._id=void 0,this.username=void 0,this.displayName=void 0,this.avatarUrl=void 0,this.isAnonymous=void 0,this.email=void 0,this.lang=void 0,this.location=void 0,this.timezone=void 0,this.metadata=void 0,this.devices=void 0,this.facebookId=void 0,this.twitterId=void 0,this.googleId=void 0,this.gameCenterId=void 0,this.steamId=void 0,this.friendIds=void 0,this.blockedUserIds=void 0,this.createdAt=void 0,this.updatedAt=void 0,this.token=void 0,this.endpoint=t.replace("ws","http"),e=Q,n=function(t){return o.token=t},i=G().getItem(e),"undefined"!=typeof Promise&&i instanceof Promise?i.then(function(t){return n(t)}):n(i)}return Object.defineProperty(t.prototype,"hasToken",{get:function(){return!!this.token},enumerable:!1,configurable:!0}),t.prototype.login=function(t){return void 0===t&&(t={}),s(this,void 0,void 0,function(){var e,n,i;return c(this,function(o){switch(o.label){case 0:return e=Object.assign({},t),this.hasToken&&(e.token=this.token),[4,this.request("post","/auth",e)];case 1:var r,s;for(i in n=o.sent(),this.token=n.token,r=Q,s=this.token,G().setItem(r,s),n)this.hasOwnProperty(i)&&(this[i]=n[i]);return this.registerPingService(),[2,this]}})})},t.prototype.save=function(){return s(this,void 0,void 0,function(){return c(this,function(t){switch(t.label){case 0:return[4,this.request("put","/auth",{},{username:this.username,displayName:this.displayName,avatarUrl:this.avatarUrl,lang:this.lang,location:this.location,timezone:this.timezone})];case 1:return t.sent(),[2,this]}})})},t.prototype.getFriends=function(){return s(this,void 0,void 0,function(){return c(this,function(t){switch(t.label){case 0:return[4,this.request("get","/friends/all")];case 1:return[2,t.sent()]}})})},t.prototype.getOnlineFriends=function(){return s(this,void 0,void 0,function(){return c(this,function(t){switch(t.label){case 0:return[4,this.request("get","/friends/online")];case 1:return[2,t.sent()]}})})},t.prototype.getFriendRequests=function(){return s(this,void 0,void 0,function(){return c(this,function(t){switch(t.label){case 0:return[4,this.request("get","/friends/requests")];case 1:return[2,t.sent()]}})})},t.prototype.sendFriendRequest=function(t){return s(this,void 0,void 0,function(){return c(this,function(e){switch(e.label){case 0:return[4,this.request("post","/friends/requests",{userId:t})];case 1:return[2,e.sent()]}})})},t.prototype.acceptFriendRequest=function(t){return s(this,void 0,void 0,function(){return c(this,function(e){switch(e.label){case 0:return[4,this.request("put","/friends/requests",{userId:t})];case 1:return[2,e.sent()]}})})},t.prototype.declineFriendRequest=function(t){return s(this,void 0,void 0,function(){return c(this,function(e){switch(e.label){case 0:return[4,this.request("del","/friends/requests",{userId:t})];case 1:return[2,e.sent()]}})})},t.prototype.blockUser=function(t){return s(this,void 0,void 0,function(){return c(this,function(e){switch(e.label){case 0:return[4,this.request("post","/friends/block",{userId:t})];case 1:return[2,e.sent()]}})})},t.prototype.unblockUser=function(t){return s(this,void 0,void 0,function(){return c(this,function(e){switch(e.label){case 0:return[4,this.request("put","/friends/block",{userId:t})];case 1:return[2,e.sent()]}})})},t.prototype.request=function(t,e,n,i,o){return void 0===n&&(n={}),void 0===o&&(o={}),s(this,void 0,void 0,function(){var r,s,a,f;return c(this,function(c){switch(c.label){case 0:for(s in o.Accept="application/json",this.hasToken&&(o.Authorization="Bearer "+this.token),r=[],n)r.push("".concat(s,"=").concat(n[s]));return a=r.length>0?"?".concat(r.join("&")):"",f={headers:o},i&&(f.body=i),[4,I[t]("".concat(this.endpoint).concat(e).concat(a),f)];case 1:return[2,c.sent().data]}})})},t.prototype.logout=function(){var t;this.token=void 0,t=Q,G().removeItem(t),this.unregisterPingService()},t.prototype.registerPingService=function(t){var e=this;void 0===t&&(t=15e3),this.unregisterPingService(),this.keepOnlineInterval=setInterval(function(){return e.request("get","/auth")},t)},t.prototype.unregisterPingService=function(){clearInterval(this.keepOnlineInterval)},t}(),tn=function(){function t(){}return t.prototype.setState=function(t){return this.state.decode(t)},t.prototype.getState=function(){return this.state},t.prototype.patch=function(t){return this.state.decode(t)},t.prototype.teardown=function(){var t,e;null===(e=null===(t=this.state)||void 0===t?void 0:t.$changes)||void 0===e||e.root.clearRefs()},t.prototype.handshake=function(t,e){this.state?new J.Reflection().decode(t,e):this.state=J.Reflection.decode(t,e)},t}(),ti=function(){function t(){}return t.prototype.setState=function(t){},t.prototype.getState=function(){return null},t.prototype.patch=function(t){},t.prototype.teardown=function(){},t.prototype.handshake=function(t){},t}();Z=tn,L.schema=Z,tt=ti,L.none=tt,t.Auth=te,t.Client=Y,t.Room=j,t.SchemaSerializer=tn,t.registerSerializer=U,Object.defineProperty(t,"__esModule",{value:!0})});
